#!/usr/bin/env ruby
# Script para reset completo do banco de dados com seeds
# Uso: ruby bin/db_reset ou bin/rails runner bin/db_reset

puts "ğŸ”„ Iniciando reset completo do banco de dados..."
puts "ğŸ—„ï¸  Ambiente atual: #{Rails.env}"

# Confirma se Ã© ambiente de desenvolvimento
unless Rails.env.development?
  puts "âŒ Este script sÃ³ pode ser executado em ambiente de desenvolvimento!"
  puts "   Ambiente atual: #{Rails.env}"
  exit 1
end

# Confirma a aÃ§Ã£o
print "âš ï¸  Tem certeza que deseja APAGAR todos os dados? (digite 'sim'): "
confirmation = gets.chomp.downcase

unless confirmation == 'sim'
  puts "âŒ OperaÃ§Ã£o cancelada."
  exit 0
end

puts "\nğŸ—‘ï¸  Removendo todos os dados..."

begin
  # Desabilita as constraints temporariamente para permitir limpeza
  ActiveRecord::Base.connection.disable_referential_integrity do
    # Lista todas as tabelas exceto as de sistema
    tables = ActiveRecord::Base.connection.tables - %w[
      schema_migrations 
      ar_internal_metadata
      active_storage_blobs
      active_storage_attachments
      active_storage_variant_records
    ]
    
    tables.each do |table|
      ActiveRecord::Base.connection.execute("DELETE FROM #{table}")
      puts "ğŸ§¹ Tabela #{table} limpa"
    end
  end

  puts "\nğŸŒ± Executando seeds..."
  
  # Carrega seeds
  Rails.application.load_seed
  
  puts "\nâœ… Reset completo finalizado!"
  puts "ğŸ‰ Banco de dados recreado com dados de desenvolvimento"
  
rescue => e
  puts "\nâŒ Erro durante o reset:"
  puts "   #{e.message}"
  puts "   Tente executar: bin/rails db:reset"
  exit 1
end
